<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sales Dialer</title>
  <script src="https://sdk.twilio.com/js/voice/releases/2.11.2/twilio.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
      background: #f2f2f7;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .dialer-card {
      background: #ffffff;
      border-radius: 24px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);
      width: 100%;
      max-width: 380px;
      overflow: hidden;
    }
    .dialer-header {
      padding: 40px 24px 32px;
      text-align: center;
      background: #ffffff;
    }
    .business-name { font-size: 18px; font-weight: 600; color: #1c1c1e; margin-bottom: 12px; word-wrap: break-word; }
    .phone-number { font-size: 34px; font-weight: 300; color: #1c1c1e; margin-bottom: 16px; font-variant-numeric: tabular-nums; }
    .call-status { font-size: 15px; color: #8e8e93; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500; margin-bottom: 8px; }
    .call-timer { font-size: 28px; font-weight: 300; color: #1c1c1e; font-variant-numeric: tabular-nums; }
    .dialer-body { padding: 0 24px 32px; }
    .error-container { margin-bottom: 20px; }
    .error-message.critical {
      background: #ffe5e5; border: 1px solid #ff3b30; color: #c7254e;
      padding: 14px; border-radius: 12px; font-size: 13px; line-height: 1.5;
    }
    .error-title { font-weight: 600; margin-bottom: 6px; font-size: 14px; }
    .error-details {
      font-size: 12px; margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.04);
      border-radius: 6px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace;
      word-break: break-word; white-space: pre-wrap;
    }
    .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
    .key {
      aspect-ratio: 1; border: none; background: #f2f2f7; border-radius: 50%;
      font-size: 28px; font-weight: 300; color: #1c1c1e; cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .key:disabled { opacity: 0.4; cursor: not-allowed; }
    .call-button {
      width: 72px; height: 72px; border: none; border-radius: 50%;
      background: #34c759; color: white; font-size: 32px; cursor: pointer;
      margin: 0 auto; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 12px rgba(52,199,89,0.3);
    }
    .call-button.hangup { background: #ff3b30; box-shadow: 0 4px 12px rgba(255,59,48,0.3); }
    .controls { display: flex; gap: 12px; justify-content: center; margin-bottom: 20px; }
    .control-btn {
      padding: 12px 24px; border: none; border-radius: 20px; font-size: 15px;
      font-weight: 500; cursor: pointer; background: #f2f2f7; color: #1c1c1e;
    }
    .control-btn.active { background: #ff3b30; color: white; }
    .control-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="dialer-card">
    <div class="dialer-header">
      <div class="business-name" id="businessName">Loading...</div>
      <div class="phone-number" id="phoneNumber">â€”</div>
      <div class="call-status" id="callStatus">Tap to Call</div>
      <div class="call-timer hidden" id="callTimer">00:00</div>
    </div>

    <div class="dialer-body">
      <div id="errorContainer" class="error-container"></div>

      <div class="keypad">
        <button class="key" disabled>1</button><button class="key" disabled>2</button><button class="key" disabled>3</button>
        <button class="key" disabled>4</button><button class="key" disabled>5</button><button class="key" disabled>6</button>
        <button class="key" disabled>7</button><button class="key" disabled>8</button><button class="key" disabled>9</button>
        <button class="key" disabled>*</button><button class="key" disabled>0</button><button class="key" disabled>#</button>
      </div>

      <div style="display:flex;justify-content:center;margin-bottom:24px;">
        <button class="call-button" id="callButton" title="Tap to Enable Mic & Call">ðŸ“ž</button>
      </div>

      <div class="controls">
        <button class="control-btn" id="muteBtn" disabled>Mute</button>
      </div>
    </div>
  </div>

  <script>
    const CONFIG = {
      tokenEndpoint: 'https://twilio-token-6608.twil.io/twilio-token',
      authKey: â€˜9c7c1f5a-8d5a-4c9e-9f21-8f7b3b5f1c92'
    };

    let device = null;
    let activeCall = null;
    let isMuted = false;
    let timer = null;
    let seconds = 0;
    let deviceInitialized = false;
    let isRegistered = false;

    const el = {
      businessName: document.getElementById('businessName'),
      phoneNumber: document.getElementById('phoneNumber'),
      callStatus: document.getElementById('callStatus'),
      callTimer: document.getElementById('callTimer'),
      errorContainer: document.getElementById('errorContainer'),
      callButton: document.getElementById('callButton'),
      muteBtn: document.getElementById('muteBtn')
    };

    function getParams() {
      const p = new URLSearchParams(location.search);
      return { to: p.get('to'), name: p.get('name') || 'Unknown Contact' };
    }

    function showError(title, details) {
      el.errorContainer.innerHTML = `
        <div class="error-message critical">
          <div class="error-title">${escapeHtml(title)}</div>
          ${details ? `<div class="error-details">${escapeHtml(details)}</div>` : ''}
        </div>`;
    }

    function clearError(){ el.errorContainer.innerHTML = ''; }
    function escapeHtml(s){ const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

    function setStatus(s){ el.callStatus.textContent = s; }

    function startTimer(){
      seconds = 0;
      el.callTimer.classList.remove('hidden');
      el.callTimer.textContent = '00:00';
      timer = setInterval(() => {
        seconds++;
        const m = String(Math.floor(seconds/60)).padStart(2,'0');
        const ss = String(seconds%60).padStart(2,'0');
        el.callTimer.textContent = `${m}:${ss}`;
      }, 1000);
    }

    function stopTimer(){
      if (timer) clearInterval(timer);
      timer = null;
      el.callTimer.classList.add('hidden');
    }

    function enableKeypad(on){
      document.querySelectorAll('.key').forEach(b => b.disabled = !on);
    }

    async function requestMic() {
      try {
        setStatus('Requesting Mic...');
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        stream.getTracks().forEach(t => t.stop());
        return true;
      } catch (e) {
        showError('Microphone Access Required', 'Allow microphone access, then tap Call again.');
        setStatus('Mic Denied');
        return false;
      }
    }

    async function initDevice() {
      if (deviceInitialized) return true;

      setStatus('Connecting...');
      clearError();

      const url = `${CONFIG.tokenEndpoint}?key=${encodeURIComponent(CONFIG.authKey)}`;
      const res = await fetch(url, { method: 'GET' });

      if (!res.ok) {
        const txt = await res.text();
        showError(`Token Error HTTP ${res.status}`, txt);
        setStatus('Token Error');
        return false;
      }

      const data = await res.json();
      if (!data.token) {
        showError('Token Missing', JSON.stringify(data));
        setStatus('Token Error');
        return false;
      }

      device = new Twilio.Device(data.token, {
        logLevel: 1,
        codecPreferences: [Twilio.Device.CodecName.Opus, Twilio.Device.CodecName.PCMU]
      });

      device.on('registered', () => {
        isRegistered = true;
        setStatus('Tap to Call');
        el.callButton.disabled = false;
        clearError();
      });

      device.on('unregistered', () => {
        isRegistered = false;
        if (!activeCall) {
          showError('Device Offline', 'Lost connection to Twilio. Refresh to reconnect.');
          setStatus('Offline');
          el.callButton.disabled = true;
        }
      });

      device.on('error', (err) => {
        showError('Device Error', err?.message || JSON.stringify(err));
        setStatus('Error');
        stopTimer();
        enableKeypad(false);
        el.muteBtn.disabled = true;
        el.callButton.textContent = 'ðŸ“ž';
        el.callButton.classList.remove('hangup');
        el.callButton.disabled = false;
        activeCall = null;
      });

      setStatus('Registering...');
      await device.register();
      deviceInitialized = true;
      return true;
    }

    function resetUIAfterCall() {
      stopTimer();
      enableKeypad(false);
      el.muteBtn.disabled = true;
      isMuted = false;
      el.muteBtn.textContent = 'Mute';
      el.muteBtn.classList.remove('active');
      el.callButton.textContent = 'ðŸ“ž';
      el.callButton.classList.remove('hangup');
      el.callButton.disabled = false;
      activeCall = null;
      if (isRegistered) setStatus('Tap to Call');
    }

    async function handleCallClick() {
      // Hang up if in call
      if (activeCall) {
        activeCall.disconnect();
        return;
      }

      const params = getParams();
      if (!params.to) {
        showError('Missing Phone Number', 'URL must include ?to=+14165551234');
        setStatus('Missing Number');
        return;
      }

      // First click flow: mic + init/register
      if (!deviceInitialized) {
        const micOk = await requestMic();
        if (!micOk) return;

        const ok = await initDevice();
        if (!ok) return;

        // You may need to click again after registered fires
        return;
      }

      if (!isRegistered) {
        showError('Device Not Ready', 'Not registered yet. Wait a moment or refresh.');
        return;
      }

      try {
        setStatus('Calling...');
        el.callButton.disabled = true;

        activeCall = await device.connect({ params: { To: params.to } });

        activeCall.on('accept', () => {
          setStatus('Connected');
          enableKeypad(true);
          el.muteBtn.disabled = false;
          startTimer();
          el.callButton.textContent = 'âœ–';
          el.callButton.classList.add('hangup');
          el.callButton.disabled = false;
        });

        activeCall.on('disconnect', resetUIAfterCall);
        activeCall.on('cancel', resetUIAfterCall);
        activeCall.on('reject', resetUIAfterCall);
        activeCall.on('error', (err) => {
          showError('Call Error', err?.message || JSON.stringify(err));
          setStatus('Call Failed');
          resetUIAfterCall();
        });

      } catch (e) {
        showError('Call Failed', e?.message || String(e));
        setStatus('Failed');
        resetUIAfterCall();
      }
    }

    // DTMF + mute
    document.querySelectorAll('.key').forEach(btn => {
      btn.addEventListener('click', () => {
        if (activeCall) activeCall.sendDigits(btn.textContent);
      });
    });

    el.muteBtn.addEventListener('click', () => {
      if (!activeCall) return;
      isMuted = !isMuted;
      activeCall.mute(isMuted);
      el.muteBtn.textContent = isMuted ? 'Unmute' : 'Mute';
      el.muteBtn.classList.toggle('active', isMuted);
    });

    el.callButton.addEventListener('click', handleCallClick);

    window.addEventListener('load', () => {
      const params = getParams();
      el.businessName.textContent = params.name;
      el.phoneNumber.textContent = params.to || 'â€”';
      setStatus(params.to ? 'Tap to Call' : 'Missing Number');
      if (!params.to) showError('Missing Phone Number', 'Open with ?to=+14165551234&name=Test');
    });

    window.addEventListener('beforeunload', () => {
      try {
        if (activeCall) activeCall.disconnect();
        if (device) device.destroy();
      } catch {}
    });
  </script>
</body>
</html>
