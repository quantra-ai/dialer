<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Opening Dialer...</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #ffffff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .fallback {
      display: none;
      text-align: center;
      padding: 40px 20px;
    }
    .fallback.show { display: block; }
    .fallback h1 {
      font-size: 20px;
      color: #1c1c1e;
      margin-bottom: 12px;
      font-weight: 600;
    }
    .fallback p {
      font-size: 14px;
      color: #8e8e93;
      margin-bottom: 24px;
      line-height: 1.5;
    }
    .fallback button {
      padding: 12px 32px;
      background: #34c759;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3);
    }
    .fallback button:hover { background: #30b350; }
    .fallback button:active { transform: scale(0.98); }
  </style>
</head>
<body>
  <div class="fallback" id="fallback">
    <h1>Popup Blocked</h1>
    <p>Please allow popups for this site, then click below:</p>
    <button id="retryBtn">Open Dialer</button>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const to = params.get('to');
    const name = params.get('name') || 'Unknown Contact';

    // If missing phone number, show fallback immediately
    if (!to) {
      document.getElementById('fallback').classList.add('show');
    }

    const dialerUrl = new URL(window.location.origin + '/');
    dialerUrl.searchParams.set('to', to || '');
    dialerUrl.searchParams.set('name', name);
    dialerUrl.searchParams.set('compact', '1');

    const popupWidth = 360;
    const popupHeight = 720;
    const popupLeft = Math.max(0, (screen.availWidth - popupWidth - 30));
    const popupTop = 80;

    const features = [
      `width=${popupWidth}`,
      `height=${popupHeight}`,
      `left=${popupLeft}`,
      `top=${popupTop}`,
      'resizable=yes',
      'scrollbars=no',
      'toolbar=no',
      'menubar=no',
      'location=no',
      'status=no'
    ].join(',');

    let popupOpened = false;

    function showFallback() {
      if (!popupOpened) {
        document.getElementById('fallback').classList.add('show');
      }
    }

    function attemptOpen() {
      if (!to) return;

      try {
        const popupWindow = window.open(dialerUrl.toString(), 'TwilioDialer', features);

        if (popupWindow && !popupWindow.closed && typeof popupWindow.closed !== 'undefined') {
          popupOpened = true;
          popupWindow.focus();

          setTimeout(() => {
            try {
              window.close();
            } catch (e) {
              document.body.innerHTML =
                '<div style="text-align:center;padding:40px;color:#8e8e93;font-size:14px;">Dialer opened. You can close this tab.</div>';
            }
          }, 250);
        } else {
          showFallback();
        }
      } catch (e) {
        showFallback();
      }
    }

    // Attempt 1: on load frame
    requestAnimationFrame(() => attemptOpen());

    // Attempt 2: after 300ms
    setTimeout(() => {
      if (!popupOpened) attemptOpen();
    }, 300);

    // Manual retry
    document.getElementById('retryBtn').addEventListener('click', attemptOpen);
  </script>
</body>
</html>
