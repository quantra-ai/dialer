<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sales Dialer</title>
  <script src="https://sdk.twilio.com/js/client/releases/1.14.0/twilio.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh; display:flex; align-items:center; justify-content:center;
      padding:20px;
    }
    .dialer-container{
      background:#fff; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,.3);
      width:100%; max-width:400px; overflow:hidden;
    }
    .dialer-header{
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#fff; padding:30px 24px; text-align:center;
    }
    .business-name{ font-size:22px; font-weight:700; margin-bottom:8px; word-wrap:break-word; }
    .phone-number{
      font-size:24px; font-weight:600; font-family:'Courier New',monospace;
      margin-bottom:12px; letter-spacing:1px;
    }
    .call-status{ font-size:14px; opacity:.95; margin-bottom:4px; text-transform:uppercase; letter-spacing:1px; }
    .call-timer{ font-size:32px; font-weight:300; font-family:'Courier New',monospace; margin-top:8px; }
    .dialer-body{ padding:24px; }
    .keypad{
      display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:20px;
    }
    .key{
      aspect-ratio:1; border:none; background:#f5f5f5; border-radius:50%;
      font-size:28px; font-weight:600; color:#333; cursor:pointer;
      transition:all .15s ease; box-shadow:0 2px 8px rgba(0,0,0,.08);
    }
    .key:hover{ background:#e8e8e8; transform:scale(1.05); }
    .key:active{ transform:scale(.95); background:#667eea; color:#fff; }
    .key:disabled{ opacity:.3; cursor:not-allowed; }
    .key:disabled:hover{ background:#f5f5f5; transform:scale(1); }
    .controls{ display:flex; gap:12px; margin-bottom:16px; }
    .control-btn{
      flex:1; padding:16px; border:none; border-radius:12px; font-size:15px;
      font-weight:600; cursor:pointer; transition:all .2s ease;
      text-transform:uppercase; letter-spacing:.5px;
    }
    .mute-btn{ background:#ffc107; color:#333; }
    .mute-btn:hover{ background:#ffb300; }
    .mute-btn.active{ background:#ff6b6b; color:#fff; }
    .hangup-btn{ background:#dc3545; color:#fff; }
    .hangup-btn:hover{ background:#c82333; }
    .hangup-btn:disabled{ opacity:.5; cursor:not-allowed; }
    .error-message{
      background:#fff3cd; border:1px solid #ffc107; color:#856404;
      padding:16px; border-radius:8px; margin-bottom:16px; font-size:14px; line-height:1.5;
    }
    .error-message.critical{ background:#f8d7da; border-color:#dc3545; color:#721c24; }
    .error-title{ font-weight:700; margin-bottom:8px; font-size:15px; }
    .error-details{
      font-size:13px; margin-top:8px; padding:8px; background:rgba(0,0,0,.05);
      border-radius:4px; font-family:monospace; word-break:break-word;
    }
    .mic-permission-prompt{
      background:#d1ecf1; border:2px solid #0c5460; color:#0c5460;
      padding:20px; border-radius:8px; margin-bottom:16px; text-align:center;
    }
    .mic-permission-prompt .icon{ font-size:48px; margin-bottom:12px; }
    .mic-permission-prompt .title{ font-weight:700; font-size:16px; margin-bottom:8px; }
    .mic-permission-prompt .instructions{ font-size:14px; line-height:1.6; }
  </style>
</head>
<body>
  <div class="dialer-container">
    <div class="dialer-header">
      <div class="business-name" id="businessName">Loading...</div>
      <div class="phone-number" id="phoneNumber">â€”</div>
      <div class="call-status" id="callStatus">Initializing</div>
      <div class="call-timer" id="callTimer">00:00</div>
    </div>

    <div class="dialer-body">
      <div id="errorContainer"></div>

      <div class="keypad">
        <button class="key" id="key1" disabled>1</button>
        <button class="key" id="key2" disabled>2</button>
        <button class="key" id="key3" disabled>3</button>
        <button class="key" id="key4" disabled>4</button>
        <button class="key" id="key5" disabled>5</button>
        <button class="key" id="key6" disabled>6</button>
        <button class="key" id="key7" disabled>7</button>
        <button class="key" id="key8" disabled>8</button>
        <button class="key" id="key9" disabled>9</button>
        <button class="key" id="keyStar" disabled>*</button>
        <button class="key" id="key0" disabled>0</button>
        <button class="key" id="keyHash" disabled>#</button>
      </div>

      <div class="controls">
        <button class="control-btn mute-btn" id="muteBtn" disabled>Mute</button>
        <button class="control-btn hangup-btn" id="hangupBtn" disabled>Hang Up</button>
      </div>
    </div>
  </div>

  <script>
    // âœ… Point this at your Twilio Functions token endpoint
    const CONFIG = {
      tokenEndpoint: 'https://twilio-token-6608.twil.io/twilio-token',
    };

    let device = null;
    let activeConnection = null;
    let isMuted = false;
    let callDuration = 0;
    let timerInterval = null;

    const elements = {
      businessName: document.getElementById('businessName'),
      phoneNumber: document.getElementById('phoneNumber'),
      callStatus: document.getElementById('callStatus'),
      callTimer: document.getElementById('callTimer'),
      errorContainer: document.getElementById('errorContainer'),
      muteBtn: document.getElementById('muteBtn'),
      hangupBtn: document.getElementById('hangupBtn')
    };

    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        to: params.get('to'),
        name: params.get('name') || 'Unknown Contact'
      };
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showError(message, details = null, isCritical = false) {
      const errorClass = isCritical ? 'error-message critical' : 'error-message';
      let html = `<div class="${errorClass}">`;
      if (isCritical) html += `<div class="error-title">${escapeHtml(message)}</div>`;
      else html += escapeHtml(message);

      if (details) html += `<div class="error-details">${escapeHtml(details)}</div>`;
      html += `</div>`;
      elements.errorContainer.innerHTML = html;
    }

    function showMicPermissionPrompt() {
      elements.errorContainer.innerHTML = `
        <div class="mic-permission-prompt">
          <div class="icon">ðŸŽ¤</div>
          <div class="title">Microphone Access Required</div>
          <div class="instructions">
            Please allow microphone access in your browser to make calls.
            <br><br>
            Look for the permission prompt in your browser's address bar and click "Allow".
          </div>
        </div>
      `;
    }

    function clearErrors() {
      elements.errorContainer.innerHTML = '';
    }

    function updateStatus(status) {
      elements.callStatus.textContent = status;
    }

    function updateTimer() {
      const minutes = Math.floor(callDuration / 60).toString().padStart(2, '0');
      const seconds = (callDuration % 60).toString().padStart(2, '0');
      elements.callTimer.textContent = `${minutes}:${seconds}`;
    }

    function startTimer() {
      callDuration = 0;
      updateTimer();
      timerInterval = setInterval(() => {
        callDuration++;
        updateTimer();
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function enableKeypad(enabled) {
      document.querySelectorAll('.key').forEach(key => key.disabled = !enabled);
    }

    function enableControls(enabled) {
      elements.muteBtn.disabled = !enabled;
      elements.hangupBtn.disabled = !enabled;
    }

    function sendDigit(digit) {
      if (activeConnection) activeConnection.sendDigits(digit);
    }

    function toggleMute() {
      if (!activeConnection) return;
      isMuted = !isMuted;
      activeConnection.mute(isMuted);
      elements.muteBtn.textContent = isMuted ? 'Unmute' : 'Mute';
      elements.muteBtn.classList.toggle('active', isMuted);
    }

    function hangUp() {
      if (activeConnection) activeConnection.disconnect();
    }

    function resetUiAfterCall() {
      enableKeypad(false);
      enableControls(false);
      isMuted = false;
      elements.muteBtn.textContent = 'Mute';
      elements.muteBtn.classList.remove('active');
      activeConnection = null;
    }

    async function initializeDialer() {
      const params = getUrlParams();

      if (!params.to) {
        showError('No phone number provided. Please open this page from the Airtable button.', null, true);
        updateStatus('Missing Number');
        return;
      }

      elements.businessName.textContent = params.name;
      elements.phoneNumber.textContent = params.to;

      try {
        updateStatus('Requesting Token...');

        const resp = await fetch(CONFIG.tokenEndpoint, { method: 'GET' });
        if (!resp.ok) throw new Error(`Token request failed: ${resp.status} ${resp.statusText}`);
        const data = await resp.json();
        if (!data.token) throw new Error('No token received from server');

        updateStatus('Initializing Device...');

        device = new Twilio.Device(data.token, {
          codecPreferences: ['opus', 'pcmu'],
          fakeLocalDTMF: true,
          enableRingingState: true,
          debug: false
        });

        device.on('error', (error) => {
          console.error('Twilio Device Error:', error);
          const msg = (error && error.message) ? error.message : String(error);

          if (
            msg.includes('Permission denied') ||
            msg.includes('NotAllowedError') ||
            msg.includes('getUserMedia')
          ) {
            showMicPermissionPrompt();
            updateStatus('Mic Access Denied');
          } else {
            showError('Device Error', msg, true);
            updateStatus('Error');
          }

          stopTimer();
          resetUiAfterCall();
        });

        device.on('offline', () => {
          if (!activeConnection) {
            showError('Device went offline. Refresh and try again.', null, true);
            updateStatus('Offline');
          }
        });

        device.on('ready', () => {
          updateStatus('Calling...');

          // IMPORTANT: This "To" must match your /dial-out function reading event.To
          try {
            activeConnection = device.connect({ To: params.to });
          } catch (e) {
            showError('Failed to initiate call', e.message || String(e), true);
            updateStatus('Failed');
            return;
          }

          // Connection events
          activeConnection.on('accept', () => {
            updateStatus('Connected');
            clearErrors();
            enableKeypad(true);
            enableControls(true);
            startTimer();
          });

          activeConnection.on('disconnect', () => {
            updateStatus('Call Ended');
            stopTimer();
            resetUiAfterCall();
          });

          activeConnection.on('cancel', () => {
            updateStatus('Call Cancelled');
            stopTimer();
            resetUiAfterCall();
          });

          activeConnection.on('reject', () => {
            updateStatus('Call Rejected');
            stopTimer();
            resetUiAfterCall();
          });

          activeConnection.on('error', (err) => {
            const msg = (err && err.message) ? err.message : String(err);
            showError('Call Error', msg, true);
            updateStatus('Error');
            stopTimer();
            resetUiAfterCall();
          });
        });

        // Not expecting incoming calls for this dialer
        device.on('incoming', (conn) => conn.reject());

      } catch (error) {
        console.error('Initialization Error:', error);
        showError('Failed to Initialize', error.message || String(error), true);
        updateStatus('Failed');
        stopTimer();
        resetUiAfterCall();
      }
    }

    // Keypad event listeners
    document.getElementById('key1').addEventListener('click', () => sendDigit('1'));
    document.getElementById('key2').addEventListener('click', () => sendDigit('2'));
    document.getElementById('key3').addEventListener('click', () => sendDigit('3'));
    document.getElementById('key4').addEventListener('click', () => sendDigit('4'));
    document.getElementById('key5').addEventListener('click', () => sendDigit('5'));
    document.getElementById('key6').addEventListener('click', () => sendDigit('6'));
    document.getElementById('key7').addEventListener('click', () => sendDigit('7'));
    document.getElementById('key8').addEventListener('click', () => sendDigit('8'));
    document.getElementById('key9').addEventListener('click', () => sendDigit('9'));
    document.getElementById('key0').addEventListener('click', () => sendDigit('0'));
    document.getElementById('keyStar').addEventListener('click', () => sendDigit('*'));
    document.getElementById('keyHash').addEventListener('click', () => sendDigit('#'));

    elements.muteBtn.addEventListener('click', toggleMute);
    elements.hangupBtn.addEventListener('click', hangUp);

    window.addEventListener('load', initializeDialer);

    window.addEventListener('beforeunload', () => {
      try {
        if (activeConnection) activeConnection.disconnect();
        if (device) device.destroy();
      } catch (e) {}
    });
  </script>
</body>
</html>
